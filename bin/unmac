#!/usr/bin/env ruby

require 'getoptlong'
require 'rubygems'
require 'unmacer'

def usage
  puts <<USAGE
unmac -- Delete spurious Mac files under a directory or volume

Usage:
  unmac [-h|--help] [-v|--verbose] [-t|--keep-trashes] [-o|--keep-apple-double-orphans] directory ...

Options:
  -h, --help                       Print this help
  -v, --verbose                    Show processing
  -t, --keep-trashes               Do not delete volume trash, if any
  -o, --keep-apple-double-orphans  Delete "._foo.txt" only if "foo.txt" exists

Description:
  The HFS file system is richer than others. When the Mac copies files to
  volumes that have a different file system it adds some files that
  represent different kinds of metadata. This typically happens with USB
  memory sticks, network drives, SD cards, etc. Mac archivers like zip(1)
  add special files as well, like "#{Unmacer::MACOSX}", you'll see them for example if
  you extract a Zip file like that on Windows.
  
  The purpose of these special files is to let another Mac rebuild the metadata
  from them. But if you are not interested in this feature your directory or
  volume just gets cluttered. This utility cleans it.

What's deleted:
  This is just a summary, for more detailed explanations and pointers see the
  comments in the source code of unmacer.rb:
  
    * Spotlight leaves a folder called "#{Unmacer::SPOTLIGHT}" in the root directory
      of volumes.

    * Time Machine relies on a folder called "#{Unmacer::FSEVENTS}" in the root directory
      of volumes.

    * A folder called "#{Unmacer::TRASHES}" in the root directory of volumes stores the
      trash corresponding to that volume.

    * Some archivers create auxiliary directories called "#{Unmacer::MACOSX}".

    * Finder and Spotlight data related to each folder gets stored in an
      extra file called "#{Unmacer::DSSTORE}".
    
    * For each file "foo.txt", its resource fork and some additional stuff
      are stored in an accompaining ghost file called "._foo.txt". The pattern
      is to prepend "._" to the original file name.
  
  Some stuff is only found in the root folder of volumes, unmac looks for them
  in any directory you pass as argument, but not on their subdirectories.
USAGE
end

opts = GetoptLong.new(
  ['--help',                      '-h', GetoptLong::NO_ARGUMENT],
  ['--verbose',                   '-v', GetoptLong::NO_ARGUMENT],
  ['--keep-trashes',              '-t', GetoptLong::NO_ARGUMENT],
  ['--keep-apple-double-orphans', '-o', GetoptLong::NO_ARGUMENT]
)

begin
  unmacer = Unmacer.new
  opts.each do |opt, val|
    case opt
    when '--help'
      usage and exit
    when '--verbose'
      unmacer.verbose = true
    when '--keep-trashes'
      unmacer.keep_trashes = true
    when '--keep-apple-double-orphans'
      unmacer.keep_apple_double_orphans = true
    end
  end
  unmacer.unmac!(ARGV)
rescue GetoptLong::InvalidOption
  usage and exit 1
end